{% extends "base.html" %}
{% load bootstrap5 %}

{% block content %}
<script>
  function toggleLike(event, button) {
    event.preventDefault();
    const postId = button.getAttribute('data-post-id');
    const isLiked = button.getAttribute('data-is-liked') === 'true';
    const url = `{% url 'like_post' pk=0 %}`.replace('0', postId);

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}',
      },
      body: JSON.stringify({}),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const likesCountElement = document.getElementById(`likes-count-${postId}`);
          likesCountElement.innerText = data.likes_count + (data.likes_count === 1 ? ' Like' : ' Likes');
          button.setAttribute('data-is-liked', !isLiked);
          button.classList.toggle('btn-primary');
          button.classList.toggle('btn-outline-secondary');
        }
      });
  }

</script>

<div class="container mt-4">
    <div class="row">
        {% for post in posts %}
        <div class="col-12 mb-4">
            <div class="card mx-auto" style="max-width: 60rem;">
                <img src="{{ post.image.url }}" class="card-img-top" alt="{{ post.description }}">
                <div class="card-body">
                    <h5 class="card-title">{{ post.user.username }}</h5>
                    <p class="card-text">{{ post.description }}</p>
                    <p class="card-text"><small class="text-muted">{{ post.created_at|timesince }} ago</small></p>
                    <div class="d-flex justify-content-between align-items-center">
                        {% with liked=post.is_liked_by user=request.user %}
                        <button type="button"
                                class="btn btn-sm {% if liked %}btn-primary{% else %}btn-outline-secondary{% endif %}"
                                data-post-id="{{ post.pk }}"
                                data-is-liked="{{ liked }}"
                                id="like-button-{{ post.pk }}"
                                onclick="toggleLike(event, this)">
                  <span id="likes-count-{{ post.pk }}">
                    {% if post.likes_count > 0 %}
                      {{ post.likes_count }} Like{% if post.likes_count > 1 %}s{% endif %}
                    {% else %}
                      Like
                    {% endif %}
                  </span>
                        </button>
                        {% endwith %}
                    </div>
                    <div class="mt-3">
                        {% for comment in post.comment_set.all %}
                        <div class="mb-2">
                            <strong><a href="{% url 'profile' user_id=comment.user.pk %}"
                                       style="text-decoration:none; color:black;">{{ comment.user.username }}</a>:</strong> {{ comment.text }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer">
                    <form method="post" action="{% url 'comment_create' pk=post.pk %}" class="d-inline">
                        {% csrf_token %}
                        <input type="text" name="text" placeholder="Write a comment..."
                               class="form-control form-control-sm">
                        <button type="submit" class="btn btn-sm btn-outline-secondary">Comment</button>
                    </form>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <p class="text-center">No posts to display.</p>
        </div>
        {% endfor %}

    </div>
</div>
{% endblock %}
